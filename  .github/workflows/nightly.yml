# .github/workflows/nightly.yml
# Project: GuardBSD Winter Saga version 1.0.0
# Package: ci_nightly
# Copyright Â© 2025 Cartesian School. Developed by Siergej Sobolewski.
# License: BSD-3-Clause

name: Nightly Build

on:
  schedule:
    # Launch every day at 02:00 UTC
    - cron: '0 2 * * *'
  # Ability to manually launch from the GitHub interface
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-nightly:
    name: Nightly ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            target: x86_64-cartesian-gbsd.json
            packages: qemu-system-x86 xorriso mtools
            artifact_path: build/x86_64/guardbsd-saga-x86_64.iso
          - arch: aarch64
            target: aarch64-cartesian-gbsd.json
            packages: qemu-system-aarch64 gcc-aarch64-linux-gnu
            artifact_path: build/aarch64/guardbsd-aarch64.iso

    steps:
      - uses: actions/checkout@v4

      # Use the Rust version fixed in rust-toolchain.toml
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@master

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}

      - name: Build Artifacts
        run: |
          chmod +x tools/build_all.sh
          ./tools/build_all.sh ${{ matrix.arch }}

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Upload Nightly Artifact
        uses: actions/upload-artifact@v4
        with:
          name: guardbsd-nightly-${{ matrix.arch }}-${{ steps.date.outputs.date }}
          path: ${{ matrix.artifact_path }}
          retention-days: 14 # Store nightly builds for 2 weeks

      # Optional: Error notification (requires permissions or webhook)
      - name: Check Failure
        if: failure()
        run: |
          echo "::error::Nightly build failed for ${{ matrix.arch }}!"
